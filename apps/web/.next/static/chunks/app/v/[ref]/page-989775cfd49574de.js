(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[409],{1933:(e,t,n)=>{"use strict";n.d(t,{IdentityChip:()=>m,KeyProvider:()=>y,U:()=>h});var r=n(4568),a=n(7620),i=n(9495);let s="identity",c="default",l="dupenet_pubkey";function o(){return new Promise((e,t)=>{let n=indexedDB.open("dupenet",1);n.onupgradeneeded=()=>{n.result.createObjectStore(s)},n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)})}async function u(){try{let e=await o();return new Promise((t,n)=>{let r=e.transaction(s,"readonly").objectStore(s).get(c);r.onsuccess=()=>{var e;return t(null!=(e=r.result)?e:null)},r.onerror=()=>n(r.error)})}catch(e){return null}}async function d(e,t,n){let r=await o();await new Promise((a,i)=>{let l=r.transaction(s,"readwrite").objectStore(s),o={privateKey:e,publicKey:t,publicKeyHex:n,createdAt:Date.now()},u=l.put(o,c);u.onsuccess=()=>a(),u.onerror=()=>i(u.error)});try{localStorage.setItem(l,n)}catch(e){}}async function f(){try{let e=await o();await new Promise((t,n)=>{let r=e.transaction(s,"readwrite").objectStore(s).delete(c);r.onsuccess=()=>t(),r.onerror=()=>n(r.error)})}catch(e){}try{localStorage.removeItem(l)}catch(e){}}let p=(0,a.createContext)({publicKeyHex:null,loading:!0,generate:async()=>{},getPrivateKey:async()=>null,clear:async()=>{}});function h(){return(0,a.useContext)(p)}function y(e){let{children:t}=e,[n,s]=(0,a.useState)(null),[c,l]=(0,a.useState)(!0);(0,a.useEffect)(()=>{u().then(e=>{e&&s(e.publicKeyHex),l(!1)})},[]);let o=(0,a.useCallback)(async()=>{let e=await (0,i.rn)(),t=(0,i.nj)(e.publicKey);await d(e.privateKey,e.publicKey,t),s(t)},[]),h=(0,a.useCallback)(async()=>{var e;let t=await u();return null!=(e=null==t?void 0:t.privateKey)?e:null},[]),y=(0,a.useCallback)(async()=>{await f(),s(null)},[]);return(0,r.jsx)(p.Provider,{value:{publicKeyHex:n,loading:c,generate:o,getPrivateKey:h,clear:y},children:t})}function m(){let{publicKeyHex:e,loading:t,generate:n,clear:a}=h();if(t)return(0,r.jsx)("span",{className:"t",children:"..."});if(!e)return(0,r.jsx)("button",{onClick:n,className:"link-btn",children:"[generate identity]"});let i=e.slice(0,4)+".."+e.slice(-4);return(0,r.jsxs)("span",{children:[(0,r.jsx)("span",{className:"t",title:e,children:i})," ",(0,r.jsx)("button",{onClick:a,className:"link-btn t",title:"clear identity",children:"x"})]})}},2796:(e,t,n)=>{"use strict";n.d(t,{FortifyButton:()=>p});var r=n(4568),a=n(7620),i=n(7541),s=n(1933),c=n(2831);function l(){return!!window.webln}async function o(e){if(!l())return null;try{return await window.webln.enable(),(await window.webln.sendPayment(e)).preimage}catch(e){return null}}let u=[210,21e3,21e6],d={210:"210",21e3:"21k",21e6:"21m"},f=["฿","\ud80c\udc20","\ud83d\udcbf","◷"];function p(e){let{poolRef:t,stats:n}=e,p=(0,i.useRouter)(),{publicKeyHex:h,generate:y,getPrivateKey:m}=(0,s.U)(),[g,w]=(0,a.useState)({step:"idle"}),[b,v]=(0,a.useState)(""),x=(0,a.useRef)(null),k=(0,a.useRef)(null);(0,a.useEffect)(()=>()=>{x.current&&clearInterval(x.current),k.current&&clearInterval(k.current)},[]);let j=(0,a.useCallback)(()=>{x.current&&(clearInterval(x.current),x.current=null),k.current&&(clearInterval(k.current),k.current=null),w({step:"idle"})},[]),N=(0,a.useCallback)(()=>{let e=0;w({step:"cycling",idx:0}),k.current=setInterval(()=>{++e>=f.length?(k.current&&clearInterval(k.current),k.current=null,w({step:"idle"}),p.refresh()):w({step:"cycling",idx:e})},350)},[p]);if(!h)return(0,r.jsx)("button",{onClick:y,className:"link-btn",title:"create key to fund",children:"+฿"});async function C(e){if(!(e<=0)&&Number.isInteger(e)&&h){w({step:"requesting"});try{let n=(0,c.UT)(t,e,h),r=(0,c.dq)(n),a=await (0,c.SY)(e,r);if(a.error)return void w({step:"error",message:a.error});if(a.dev_mode){w({step:"confirming",event:n}),await S(n);return}if(a.invoice&&l()&&(w({step:"confirming",event:n}),await o(a.invoice)))return void await S(n);if(a.invoice&&a.payment_hash){w({step:"paying",invoice:a.invoice,paymentHash:a.payment_hash,event:n}),x.current=setInterval(async()=>{try{(await (0,c.Lh)(a.payment_hash)).settled&&(x.current&&clearInterval(x.current),x.current=null,w({step:"confirming",event:n}),await S(n))}catch(e){}},3e3);return}w({step:"error",message:"unexpected response"})}catch(e){w({step:"error",message:String(e)})}}}async function S(e){try{let n=await m();if(!n)return void w({step:"error",message:"key not found"});let r=await (0,c.hs)(e,n),a=await (0,c.tk)(r);if(a.ok)N();else{var t;w({step:"error",message:null!=(t=a.error)?t:"rejected"})}}catch(e){w({step:"error",message:String(e)})}}if("idle"===g.step)return(0,r.jsx)("button",{onClick:()=>w({step:"picking"}),className:"link-btn",children:"+฿"});if("picking"===g.step)return(0,r.jsxs)("span",{className:"fortify-row",children:[u.map(e=>{var t;return(0,r.jsx)("button",{onClick:()=>C(e),className:"link-btn",children:null!=(t=d[e])?t:String(e)},e)})," ",(0,r.jsx)("input",{type:"number",min:"1",placeholder:"_",value:b,onChange:e=>v(e.target.value),className:"inline-input",onKeyDown:e=>{"Enter"===e.key&&C(parseInt(b,10))}}),(0,r.jsx)("button",{onClick:()=>C(parseInt(b,10)),className:"link-btn",children:"฿"})," ",(0,r.jsx)("button",{onClick:j,className:"link-btn t",children:"x"})]});if("requesting"===g.step||"confirming"===g.step)return(0,r.jsxs)("span",{className:"t",children:["฿","..."]});if("cycling"===g.step)return(0,r.jsx)("span",{className:"cycle-icon",children:f[g.idx]});if("paying"===g.step){let e=g.invoice.slice(0,36)+"...";return(0,r.jsxs)("div",{className:"invoice-box",children:[(0,r.jsx)("a",{href:"lightning:".concat(g.invoice),className:"invoice-link",children:e})," ",(0,r.jsx)("button",{onClick:()=>navigator.clipboard.writeText(g.invoice).catch(()=>{}),className:"link-btn",children:"copy"}),(0,r.jsx)("br",{}),(0,r.jsxs)("span",{className:"t",children:["฿","..."]})," ",(0,r.jsx)("button",{onClick:j,className:"link-btn t",children:"x"})]})}return"error"===g.step?(0,r.jsxs)("span",{children:[(0,r.jsx)("span",{className:"t",children:g.message})," ",(0,r.jsx)("button",{onClick:j,className:"link-btn",children:"+฿"})]}):null}},2831:(e,t,n)=>{"use strict";n.d(t,{UT:()=>l,Lh:()=>h,hq:()=>d,dq:()=>o,tk:()=>f,SY:()=>p,hs:()=>u});var r=n(9495),a=n(1017),i=n(4595);let s="0001"+"0".repeat(60);function c(e){let t=BigInt("0x"+s);for(let n=0n;n<BigInt(1e7);n++){let r=new Uint8Array(8);new DataView(r.buffer).setBigUint64(0,n,!1);let s=new Uint8Array(e.length+8);s.set(e,0),s.set(r,e.length);let c=(0,i.My)((0,a.sc)(s));if(BigInt("0x"+c)<t)return{nonceHex:n.toString(16).padStart(16,"0"),powHash:c}}throw Error("PoW: no valid nonce found")}function l(e,t,n){return{v:1,kind:1,from:n,ref:e,body:"",sats:t,ts:Date.now()}}function o(e){return(0,r.VB)(e)}async function u(e,t){return(0,r.a2)(t,e)}async function d(e,t,l,o,u){let d={v:1,kind:3,from:o,ref:e,body:(0,r.DJ)({text:t}),sats:0,ts:Date.now()};u&&u();let f=await function(e){let t=function(e){let t=new TextEncoder().encode("EV1_POW"),n=(0,i.aT)(e.from),r=new Uint8Array(8);new DataView(r.buffer).setBigUint64(0,BigInt(e.ts),!1);let s=new Uint8Array([e.kind]),c=(0,i.aT)(e.ref),l=e.body.length>0?(0,i.aT)(e.body):new Uint8Array(0),o=(0,a.sc)(l),u=new Uint8Array(t.length+n.length+8+1+c.length+32),d=0;return u.set(t,d),d+=t.length,u.set(n,d),d+=n.length,u.set(r,d),d+=8,u.set(s,d),d+=1,u.set(c,d),d+=c.length,u.set(o,d),(0,a.sc)(u)}(e),r=(0,i.My)(t);return"undefined"!=typeof Worker?new Promise((e,a)=>{try{let i=new Worker(n.tu(new URL(n.p+n.u(187),n.b)));i.onmessage=t=>{i.terminate(),t.data.error?a(Error(t.data.error)):e({nonceHex:t.data.nonceHex,powHash:t.data.powHash})},i.onerror=n=>{i.terminate(),e(c(t))},i.postMessage({challengeHex:r,targetHex:s,maxAttempts:1e7})}catch(n){e(c(t))}}):Promise.resolve(c(t))}(d);return{...await (0,r.a2)(l,d),pow_nonce:f.nonceHex,pow_hash:f.powHash}}async function f(e){return(await fetch("/api/event",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json()}async function p(e,t){return(await fetch("/api/payreq",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sats:e,event_hash:t})})).json()}async function h(e){return(await fetch("/api/payreq/".concat(e),{cache:"no-store"})).json()}},7541:(e,t,n)=>{"use strict";var r=n(3041);n.o(r,"useRouter")&&n.d(t,{useRouter:function(){return r.useRouter}})},8445:(e,t,n)=>{"use strict";n.d(t,{CommentBox:()=>l});var r=n(4568),a=n(7620),i=n(7541),s=n(1933),c=n(2831);function l(e){let{parentRef:t}=e,n=(0,i.useRouter)(),{publicKeyHex:l,generate:o,getPrivateKey:u}=(0,s.U)(),[d,f]=(0,a.useState)(""),[p,h]=(0,a.useState)("idle"),[y,m]=(0,a.useState)("");if(!l)return(0,r.jsx)("button",{onClick:o,className:"link-btn",title:"create key to comment",children:"\ud83d\udcac"});async function g(){let e=d.trim();if(e&&l){h("mining"),m("");try{let a=await u();if(!a){h("error"),m("key not found");return}let i=await (0,c.hq)(t,e,a,l,()=>{h("mining")});h("sending");let s=await (0,c.tk)(i);if(s.ok)h("sent"),f(""),setTimeout(()=>{h("idle"),n.refresh()},1e3);else{var r;h("error"),m(null!=(r=s.error)?r:"rejected"),setTimeout(()=>h("idle"),3e3)}}catch(e){h("error"),m(String(e)),setTimeout(()=>h("idle"),3e3)}}}return"mining"===p?(0,r.jsxs)("span",{className:"t",children:["\ud83d\udcac","mining..."]}):"sending"===p?(0,r.jsxs)("span",{className:"t",children:["\ud83d\udcac","sending..."]}):"sent"===p?(0,r.jsxs)("span",{children:["\ud83d\udcac","✓"]}):"error"===p?(0,r.jsxs)("span",{children:[(0,r.jsx)("span",{className:"t",children:y})," ",(0,r.jsx)("button",{onClick:()=>h("idle"),className:"link-btn",children:"\ud83d\udcac"})]}):(0,r.jsxs)("div",{className:"comment-box",children:[(0,r.jsx)("textarea",{value:d,onChange:e=>f(e.target.value),rows:3,className:"comment-input"}),(0,r.jsx)("br",{}),(0,r.jsx)("button",{onClick:g,className:"link-btn",disabled:!d.trim(),children:"\ud83d\udcac"})]})}},9495:(e,t,n)=>{"use strict";n.d(t,{DJ:()=>h,VB:()=>f,a2:()=>p,nj:()=>s,rn:()=>u});var r=n(3726),a=n(1017),i=n(4595);r.jn.sha512Sync=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];let r=a.Zf.create();for(let e of t)r.update(e);return r.digest()};let s=i.My,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function l(e,t){let n=e<<5;if(t<24)return[n|t];if(t<256)return[24|n,t];if(t<65536)return[25|n,t>>8&255,255&t];if(t<0x100000000)return[26|n,t>>>24&255,t>>>16&255,t>>>8&255,255&t];let r=Math.floor(t/0x100000000),a=t>>>0;return[27|n,r>>>24&255,r>>>16&255,r>>>8&255,255&r,a>>>24&255,a>>>16&255,a>>>8&255,255&a]}function o(e){return new Uint8Array(function e(t){if(null==t)return[246];if("boolean"==typeof t)return[t?245:244];if("number"==typeof t){if(!Number.isInteger(t)||t<0)throw Error("only non-negative integers supported");return l(0,t)}if("string"==typeof t){let e=new TextEncoder().encode(t);return[...l(3,e.length),...e]}if(t instanceof Uint8Array)return[...l(2,t.length),...t];if(Array.isArray(t)){let n=l(4,t.length);for(let r of t)n.push(...e(r));return n}if("object"==typeof t){let n=Object.keys(t).sort(),r=l(5,n.length);for(let a of n)r.push(...e(a)),r.push(...e(t[a]));return r}throw Error("unsupported CBOR type: ".concat(typeof t))}(e))}async function u(){let e=crypto.getRandomValues(new Uint8Array(32)),t=await (0,r.lG)(e);return{privateKey:e,publicKey:t}}function d(e){return{v:e.v,kind:e.kind,from:e.from,ref:e.ref,body:e.body,sats:e.sats,ts:e.ts}}function f(e){var t;return s((t=o(d(e)),(0,a.sc)(t)))}async function p(e,t){let n=o(d(t)),a=await (0,r._S)(n,e);return{...t,sig:function(e){let t="";for(let a=0;a<e.length;a+=3){var n,r;let i=e[a],s=null!=(n=e[a+1])?n:0,l=null!=(r=e[a+2])?r:0;t+=c[i>>2],t+=c[(3&i)<<4|s>>4],a+1<e.length?t+=c[(15&s)<<2|l>>6]:t+="=",a+2<e.length?t+=c[63&l]:t+="="}return t}(a)}}function h(e){return s(o(e))}},9974:(e,t,n)=>{Promise.resolve().then(n.bind(n,8445)),Promise.resolve().then(n.bind(n,2796))}},e=>{e.O(0,[175,587,18,358],()=>e(e.s=9974)),_N_E=e.O()}]);