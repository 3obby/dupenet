(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[409],{1933:(e,t,n)=>{"use strict";n.d(t,{IdentityChip:()=>m,KeyProvider:()=>y,U:()=>h});var r=n(4568),i=n(7620),a=n(9495);let s="identity",l="default",o="dupenet_pubkey";function c(){return new Promise((e,t)=>{let n=indexedDB.open("dupenet",1);n.onupgradeneeded=()=>{n.result.createObjectStore(s)},n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)})}async function u(){try{let e=await c();return new Promise((t,n)=>{let r=e.transaction(s,"readonly").objectStore(s).get(l);r.onsuccess=()=>{var e;return t(null!=(e=r.result)?e:null)},r.onerror=()=>n(r.error)})}catch(e){return null}}async function d(e,t,n){let r=await c();await new Promise((i,a)=>{let o=r.transaction(s,"readwrite").objectStore(s),c={privateKey:e,publicKey:t,publicKeyHex:n,createdAt:Date.now()},u=o.put(c,l);u.onsuccess=()=>i(),u.onerror=()=>a(u.error)});try{localStorage.setItem(o,n)}catch(e){}}async function f(){try{let e=await c();await new Promise((t,n)=>{let r=e.transaction(s,"readwrite").objectStore(s).delete(l);r.onsuccess=()=>t(),r.onerror=()=>n(r.error)})}catch(e){}try{localStorage.removeItem(o)}catch(e){}}let p=(0,i.createContext)({publicKeyHex:null,loading:!0,generate:async()=>{},getPrivateKey:async()=>null,clear:async()=>{}});function h(){return(0,i.useContext)(p)}function y(e){let{children:t}=e,[n,s]=(0,i.useState)(null),[l,o]=(0,i.useState)(!0);(0,i.useEffect)(()=>{u().then(e=>{e&&s(e.publicKeyHex),o(!1)})},[]);let c=(0,i.useCallback)(async()=>{let e=await (0,a.rn)(),t=(0,a.nj)(e.publicKey);await d(e.privateKey,e.publicKey,t),s(t)},[]),h=(0,i.useCallback)(async()=>{var e;let t=await u();return null!=(e=null==t?void 0:t.privateKey)?e:null},[]),y=(0,i.useCallback)(async()=>{await f(),s(null)},[]);return(0,r.jsx)(p.Provider,{value:{publicKeyHex:n,loading:l,generate:c,getPrivateKey:h,clear:y},children:t})}function m(){let{publicKeyHex:e,loading:t,generate:n,clear:i}=h();if(t)return(0,r.jsx)("span",{className:"t",children:"..."});if(!e)return(0,r.jsx)("button",{onClick:n,className:"link-btn",children:"[generate identity]"});let a=e.slice(0,4)+".."+e.slice(-4);return(0,r.jsxs)("span",{children:[(0,r.jsx)("span",{className:"t",title:e,children:a})," ",(0,r.jsx)("button",{onClick:i,className:"link-btn t",title:"clear identity",children:"x"})]})}},2490:(e,t,n)=>{"use strict";n.d(t,{Lh:()=>u,SY:()=>c,UT:()=>i,dq:()=>a,hq:()=>l,hs:()=>s,tk:()=>o});var r=n(9495);function i(e,t,n){return{v:1,kind:1,from:n,ref:e,body:"",sats:t,ts:Date.now()}}function a(e){return(0,r.VB)(e)}async function s(e,t){return(0,r.a2)(t,e)}async function l(e,t,n,i){let a=(0,r.DJ)({text:t});return(0,r.a2)(n,{v:1,kind:3,from:i,ref:e,body:a,sats:0,ts:Date.now()})}async function o(e){return(await fetch("/api/event",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json()}async function c(e,t){return(await fetch("/api/payreq",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sats:e,event_hash:t})})).json()}async function u(e){return(await fetch("/api/payreq/".concat(e),{cache:"no-store"})).json()}},2796:(e,t,n)=>{"use strict";n.d(t,{FortifyButton:()=>d});var r=n(4568),i=n(7620),a=n(7541),s=n(1933),l=n(2490);function o(){return!!window.webln}async function c(e){if(!o())return null;try{return await window.webln.enable(),(await window.webln.sendPayment(e)).preimage}catch(e){return null}}let u=[21,210,2100];function d(e){let{poolRef:t}=e,n=(0,a.useRouter)(),{publicKeyHex:d,generate:f,getPrivateKey:p}=(0,s.U)(),[h,y]=(0,i.useState)({step:"idle"}),[m,b]=(0,i.useState)(""),v=(0,i.useRef)(null);(0,i.useEffect)(()=>()=>{v.current&&clearInterval(v.current)},[]);let g=(0,i.useCallback)(()=>{v.current&&(clearInterval(v.current),v.current=null),y({step:"idle"})},[]);if(!d)return(0,r.jsxs)("span",{children:[(0,r.jsx)("button",{onClick:f,className:"link-btn",children:"[fortify]"})," ",(0,r.jsx)("span",{className:"t",children:"(create key first)"})]});async function w(e){if(!(e<=0)&&Number.isInteger(e)&&d){y({step:"requesting"});try{let n=(0,l.UT)(t,e,d),r=(0,l.dq)(n),i=await (0,l.SY)(e,r);if(i.error)return void y({step:"error",message:i.error});if(i.dev_mode){y({step:"confirming",event:n}),await k(n);return}if(i.invoice&&o()&&(y({step:"confirming",event:n}),await c(i.invoice)))return void await k(n);if(i.invoice&&i.payment_hash){y({step:"paying",invoice:i.invoice,paymentHash:i.payment_hash,event:n}),v.current=setInterval(async()=>{try{(await (0,l.Lh)(i.payment_hash)).settled&&(v.current&&clearInterval(v.current),v.current=null,y({step:"confirming",event:n}),await k(n))}catch(e){}},3e3);return}y({step:"error",message:"unexpected payreq response"})}catch(e){y({step:"error",message:String(e)})}}}async function k(e){try{let r=await p();if(!r)return void y({step:"error",message:"key not found"});let i=await (0,l.hs)(e,r),a=await (0,l.tk)(i);if(a.ok)y({step:"done"}),setTimeout(()=>{g(),n.refresh()},1500);else{var t;y({step:"error",message:null!=(t=a.error)?t:"event rejected"})}}catch(e){y({step:"error",message:String(e)})}}if("idle"===h.step)return(0,r.jsx)("button",{onClick:()=>y({step:"picking"}),className:"link-btn",children:"[fortify]"});if("picking"===h.step)return(0,r.jsxs)("span",{className:"fortify-row",children:[u.map(e=>(0,r.jsx)("button",{onClick:()=>w(e),className:"link-btn",children:e},e))," ",(0,r.jsx)("input",{type:"number",min:"1",placeholder:"custom",value:m,onChange:e=>b(e.target.value),className:"inline-input",onKeyDown:e=>{"Enter"===e.key&&w(parseInt(m,10))}}),(0,r.jsx)("button",{onClick:()=>w(parseInt(m,10)),className:"link-btn",children:"go"})," ",(0,r.jsx)("span",{className:"t",children:"sat"})," ",(0,r.jsx)("button",{onClick:g,className:"link-btn t",children:"x"})]});if("requesting"===h.step||"confirming"===h.step)return(0,r.jsx)("span",{className:"t",children:"requesting"===h.step?"creating invoice...":"confirming..."});if("paying"===h.step){let e=h.invoice.slice(0,40)+"...";return(0,r.jsxs)("div",{className:"invoice-box",children:[(0,r.jsx)("span",{className:"t",children:"pay this invoice to fortify:"}),(0,r.jsx)("br",{}),(0,r.jsx)("a",{href:"lightning:".concat(h.invoice),className:"invoice-link",title:"Open in Lightning wallet",children:e})," ",(0,r.jsx)("button",{onClick:()=>{var e;return e=h.invoice,void navigator.clipboard.writeText(e).catch(()=>{})},className:"link-btn",title:"Copy full invoice",children:"copy"}),(0,r.jsx)("br",{}),(0,r.jsx)("span",{className:"t",children:"waiting for payment..."})," ",(0,r.jsx)("button",{onClick:g,className:"link-btn t",children:"cancel"})]})}return"done"===h.step?(0,r.jsx)("span",{children:"+ funded"}):"error"===h.step?(0,r.jsxs)("span",{children:["failed: ",h.message," —"," ",(0,r.jsx)("button",{onClick:g,className:"link-btn",children:"retry"})]}):null}},7541:(e,t,n)=>{"use strict";var r=n(3041);n.o(r,"useRouter")&&n.d(t,{useRouter:function(){return r.useRouter}})},8445:(e,t,n)=>{"use strict";n.d(t,{CommentBox:()=>o});var r=n(4568),i=n(7620),a=n(7541),s=n(1933),l=n(2490);function o(e){let{parentRef:t}=e,n=(0,a.useRouter)(),{publicKeyHex:o,generate:c,getPrivateKey:u}=(0,s.U)(),[d,f]=(0,i.useState)(""),[p,h]=(0,i.useState)("idle"),[y,m]=(0,i.useState)("");if(!o)return(0,r.jsx)("span",{className:"t",children:(0,r.jsx)("button",{onClick:c,className:"link-btn",children:"[create key to comment]"})});async function b(){let e=d.trim();if(e&&o){h("sending"),m("");try{let i=await u();if(!i){h("error"),m("key not found");return}let a=await (0,l.hq)(t,e,i,o),s=await (0,l.tk)(a);if(s.ok)h("sent"),f(""),setTimeout(()=>{h("idle"),n.refresh()},1e3);else{var r;h("error"),m(null!=(r=s.error)?r:"unknown error"),setTimeout(()=>h("idle"),3e3)}}catch(e){h("error"),m(String(e)),setTimeout(()=>h("idle"),3e3)}}}return"sending"===p?(0,r.jsx)("span",{className:"t",children:"posting..."}):"sent"===p?(0,r.jsx)("span",{children:"+ posted"}):"error"===p?(0,r.jsxs)("span",{children:["failed",y?": ".concat(y):""," —"," ",(0,r.jsx)("button",{onClick:()=>h("idle"),className:"link-btn",children:"retry"})]}):(0,r.jsxs)("div",{className:"comment-box",children:[(0,r.jsx)("textarea",{value:d,onChange:e=>f(e.target.value),placeholder:"comment...",rows:3,className:"comment-input"}),(0,r.jsx)("br",{}),(0,r.jsx)("button",{onClick:b,className:"link-btn",disabled:!d.trim(),children:"[post]"})]})}},9495:(e,t,n)=>{"use strict";n.d(t,{DJ:()=>h,VB:()=>f,a2:()=>p,nj:()=>s,rn:()=>u});var r=n(3726),i=n(3761),a=n(4595);r.jn.sha512Sync=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];let r=i.Zf.create();for(let e of t)r.update(e);return r.digest()};let s=a.My,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function o(e,t){let n=e<<5;if(t<24)return[n|t];if(t<256)return[24|n,t];if(t<65536)return[25|n,t>>8&255,255&t];if(t<0x100000000)return[26|n,t>>>24&255,t>>>16&255,t>>>8&255,255&t];let r=Math.floor(t/0x100000000),i=t>>>0;return[27|n,r>>>24&255,r>>>16&255,r>>>8&255,255&r,i>>>24&255,i>>>16&255,i>>>8&255,255&i]}function c(e){return new Uint8Array(function e(t){if(null==t)return[246];if("boolean"==typeof t)return[t?245:244];if("number"==typeof t){if(!Number.isInteger(t)||t<0)throw Error("only non-negative integers supported");return o(0,t)}if("string"==typeof t){let e=new TextEncoder().encode(t);return[...o(3,e.length),...e]}if(t instanceof Uint8Array)return[...o(2,t.length),...t];if(Array.isArray(t)){let n=o(4,t.length);for(let r of t)n.push(...e(r));return n}if("object"==typeof t){let n=Object.keys(t).sort(),r=o(5,n.length);for(let i of n)r.push(...e(i)),r.push(...e(t[i]));return r}throw Error("unsupported CBOR type: ".concat(typeof t))}(e))}async function u(){let e=crypto.getRandomValues(new Uint8Array(32)),t=await (0,r.lG)(e);return{privateKey:e,publicKey:t}}function d(e){return{v:e.v,kind:e.kind,from:e.from,ref:e.ref,body:e.body,sats:e.sats,ts:e.ts}}function f(e){var t;return s((t=c(d(e)),(0,i.sc)(t)))}async function p(e,t){let n=c(d(t)),i=await (0,r._S)(n,e);return{...t,sig:function(e){let t="";for(let i=0;i<e.length;i+=3){var n,r;let a=e[i],s=null!=(n=e[i+1])?n:0,o=null!=(r=e[i+2])?r:0;t+=l[a>>2],t+=l[(3&a)<<4|s>>4],i+1<e.length?t+=l[(15&s)<<2|o>>6]:t+="=",i+2<e.length?t+=l[63&o]:t+="="}return t}(i)}}function h(e){return s(c(e))}},9974:(e,t,n)=>{Promise.resolve().then(n.bind(n,8445)),Promise.resolve().then(n.bind(n,2796))}},e=>{e.O(0,[70,587,18,358],()=>e(e.s=9974)),_N_E=e.O()}]);