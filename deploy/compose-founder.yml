# Founder stack — full protocol deployment.
# DocRef: MVP_PLAN:§What Hosts vs What You Host, §Node Kit
#
# Run: docker compose -f deploy/compose-founder.yml up

services:
  gateway:
    build:
      context: ..
      dockerfile: apps/gateway/Dockerfile
    ports:
      - "3100:3100"
    environment:
      GATEWAY_PORT: "3100"
      BLOCK_STORE_PATH: /data/blocks
      LND_HOST: lnd:10009
      MINT_URL: http://mint:3101
    volumes:
      - block-data:/data/blocks
    depends_on:
      - lnd
      - mint
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3100/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  mint:
    build:
      context: ..
      dockerfile: apps/mint/Dockerfile
    environment:
      MINT_PORT: "3101"
      MINT_PRIVATE_KEY_HEX: ${MINT_PRIVATE_KEY_HEX}
      LND_HOST: lnd:10009
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3101/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  coordinator:
    build:
      context: ..
      dockerfile: apps/coordinator/Dockerfile
    ports:
      - "3102:3102"
    environment:
      COORDINATOR_PORT: "3102"
      DATABASE_URL: postgresql://dupenet:dupenet@postgres:5432/dupenet
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3102/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: dupenet
      POSTGRES_PASSWORD: dupenet
      POSTGRES_DB: dupenet
    volumes:
      - pg-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dupenet"]
      interval: 5s
      timeout: 5s
      retries: 5

  lnd:
    image: lightninglabs/lnd:v0.18.0-beta
    command:
      - --bitcoin.active
      - --bitcoin.regtest
      - --bitcoin.node=neutrino
      - --noseedbackup
      - --rpclisten=0.0.0.0:10009
    volumes:
      - lnd-data:/root/.lnd
    healthcheck:
      test: ["CMD", "lncli", "--network=regtest", "getinfo"]
      interval: 10s
      timeout: 5s
      retries: 10

  caddy:
    image: caddy:2-alpine
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      - gateway
      - coordinator

volumes:
  block-data:
  pg-data:
  lnd-data:
  caddy-data:
  caddy-config:
