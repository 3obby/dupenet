# Node operator kit — minimal deployment for hosts.
# DocRef: MVP_PLAN:§Node Kit
#
# Run: docker compose -f deploy/compose-nodekit.yml --env-file .env.local up --build

services:
  gateway:
    build:
      context: ..
      dockerfile: apps/gateway/Dockerfile
    ports:
      - "3100:3100"
    environment:
      GATEWAY_PORT: "3100"
      BLOCK_STORE_PATH: /data/blocks
      HOST_PUBKEY: ${HOST_PUBKEY}
      MINT_URL: ${MINT_URL:-http://mint.dupenet.example:3101}
      MIN_REQUEST_SATS: ${MIN_REQUEST_SATS:-3}
      SATS_PER_GB: ${SATS_PER_GB:-500}
      # Nodekit gateway runs in dev mode (no local LND) — L402 handled by remote mint
    volumes:
      - block-data:/data/blocks
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3100/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  agent:
    build:
      context: ..
      dockerfile: apps/node-agent/Dockerfile
    environment:
      AGENT_GATEWAY_URL: http://gateway:3100
      AGENT_COORDINATOR_URL: ${COORDINATOR_URL:-http://coordinator.dupenet.example:3102}
      AGENT_HOST_PUBKEY: ${HOST_PUBKEY}
      AGENT_HOST_PRIVATE_KEY_HEX: ${AGENT_HOST_PRIVATE_KEY_HEX}
      AGENT_HOST_ENDPOINT: ${AGENT_HOST_ENDPOINT}
      AGENT_MIN_REQUEST_SATS: ${MIN_REQUEST_SATS:-3}
      AGENT_SATS_PER_GB: ${SATS_PER_GB:-500}
      AGENT_POLL_INTERVAL_MS: ${AGENT_POLL_INTERVAL_MS:-60000}
      AGENT_MIN_BOUNTY: ${AGENT_MIN_BOUNTY:-100}
      AGENT_MAX_MIRRORS_PER_CYCLE: ${AGENT_MAX_MIRRORS_PER_CYCLE:-5}
    depends_on:
      gateway:
        condition: service_healthy

  caddy:
    image: caddy:2-alpine
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./Caddyfile.nodekit:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      gateway:
        condition: service_healthy

volumes:
  block-data:
  caddy-data:
  caddy-config:
